# 멀티프로세서 스케줄링

멀티프로세서 스케줄링은 여러 CPU에서 작업을 어떻게 나눠 실행할 것인가에 대한 문제이다.

단일 CPU 스케줄링의 아이디어를 그대로 확장하면 새로운 문제가 바로 드러난다.

핵심 질문은 다음과 같다.

- 여러 CPU에 작업을 어떻게 배치할 것인가
- 확장성 캐시 친화성 공정성을 어떻게 만족시킬 것인가

---

### 멀티프로세서 구조의 특징

멀티프로세서 환경에서는 하드웨어 구조 자체가 스케줄링에 직접적인 영향을 준다.

캐시와 공유 메모리 측면에서 보면

- 각 CPU는 자신만의 캐시를 가진다.
- 여러 CPU가 하나의 메인 메모리를 공유한다.
- 이로 인해 캐시 일관성 문제가 발생한다.
- 하드웨어는 버스 스누핑 등의 방식으로 일관성을 유지한다.
- 메모리 변경이 감지되면 캐시 무효화 또는 갱신이 일어난다.

**동기화 문제**도 함께 따라온다.

- 여러 CPU가 동일한 데이터 구조를 동시에 수정하면 문제가 발생한다.
- 캐시 일관성만으로는 충분하지 않다.
- 락과 같은 동기화 기법이 필요하다.
- CPU 수가 증가할수록 동기화 오버헤드는 커진다.

또 하나 중요한 요소는 **캐시 친화성**이다.

- 프로세스는 실행되며 CPU의 캐시와 TLB에 상태를 쌓는다.
- 같은 CPU에서 계속 실행될수록 성능이 좋다.
- CPU를 자주 옮기면 캐시를 다시 채워야 한다.
- 멀티프로세서 스케줄러는 캐시 친화성을 반드시 고려해야 한다.

---

### 단일 큐 멀티프로세서 스케줄링 SQMS

단일 큐 멀티프로세서 스케줄링은 **모든 CPU가 하나의 전역 스케줄링 큐를 공유**하는 방식이다.

단일 CPU 스케줄링을 가장 직관적으로 확장한 구조이다.

장점은 명확하다.

- 구현이 단순하다.
- 기존 단일 CPU 스케줄러를 쉽게 확장할 수 있다.
- 전체 워크로드 균형을 맞추기 쉽다.

하지만 단점도 명확하다.

- 전역 큐 접근을 위한 락이 필요하다.
- CPU 수가 늘어날수록 락 경쟁이 심해진다.
- 작업이 CPU 사이를 자주 이동한다.
- 캐시 친화성이 나쁘다.

**확장성**이 가장 큰 약점이다.

---

### 멀티 큐 멀티프로세서 스케줄링 MQMS

멀티 큐 방식은 **CPU마다 하나의 스케줄링 큐**를 가지는 구조이다.

각 CPU는 자신의 큐만 보고 스케줄링을 수행한다.

이 방식의 장점은 다음과 같다.

- 큐 간 락 경쟁이 거의 없다.
- CPU 수가 늘어날수록 확장성이 좋다.
- 작업이 같은 CPU에서 실행되어 캐시 친화성이 높다.

반면 단점도 존재한다.

- 각 큐의 작업 수가 달라질 수 있다.
- 어떤 CPU는 바쁘고 어떤 CPU는 놀게 된다.
- 전체 CPU 사용률이 떨어질 수 있다.

---

### 워크로드 불균형과 작업 이주

멀티 큐 방식의 핵심 문제는 워크로드 불균형이다.

이를 해결하기 위해 작업을 한 CPU의 큐에서 다른 CPU의 큐로 옮긴다.

이를 작업 이주라고 한다.

대표적인 방식이 **작업 훔치기**이다.

- 작업이 적은 CPU가 다른 큐를 검사한다.
- 다른 큐에 작업이 많으면 일부 작업을 가져온다.
- 워크로드 균형을 회복한다.

하지만 trade off가 존재한다.

- 너무 자주 검사하면 오버헤드가 커진다.
- 너무 드물면 불균형이 오래 유지된다.
- 적절한 균형점을 찾는 것이 핵심이다.

---

### 실제 시스템의 선택

현실의 운영체제는 단일 큐와 멀티 큐 방식을 모두 사용해 왔다.

Linux의 예를 보면 다음과 같다.

- O(1) 스케줄러
    - 우선순위 기반
    - MLFQ 계열

- CFS
    - 결정론적 비례 배분
    - 보폭 스케줄링과 유사

- BFS
    - 단일 큐 기반
    - 비례 배분 방식

단일 큐와 멀티 큐 방식은 각각 장단점이 있으며 정답은 하나가 아니다.

멀티프로세서 스케줄링은 확장성 공정성 캐시 친화성 사이에서 어디에 균형을 둘 것인가에 대한 선택의 문제이다.
