# 제한적 직접 실행 (Limited Direct Execution)

### 제한적 직접 실행이란?

제한적 직접 실행(Limited Direct Execution, LDE)은 **프로그램을 CPU에서 직접 실행하되 운영체제가 언제든 제어권을 되찾을 수 있도록 제한을 거는 실행 방식**이다.

성능을 위해서는 프로그램을 CPU에서 직접 실행해야 하지만 제어를 위해서는 운영체제가 실행 흐름에 개입할 수 있어야 한다.  
LDE는 이 두 요구를 동시에 만족시키기 위한 설계이다.

---

### 왜 제한적 직접 실행이 필요한가?

CPU 가상화의 목표는 **하나의 물리 CPU를 여러 프로세스가 동시에 실행되는 것처럼 보이게 하는 것**이다.

이를 위해 운영체제는 다음 두 가지를 모두 만족해야 한다.

- **성능**
    - 프로그램은 가능한 한 빠르게 실행되어야 한다.
- **제어**
    - 특정 프로세스가 CPU를 독점하거나
    - 시스템 자원을 무단으로 사용하는 것을 막아야 한다.

프로그램을 커널이 직접 해석하며 실행하면 제어는 쉬워지지만 성능이 너무 느리다.  
반대로 프로그램을 완전히 자유롭게 실행하면 성능은 좋지만 제어가 불가능하다.

이 충돌을 해결하기 위한 방법이 제한적 직접 실행이다.

---

### 제한적 직접 실행의 핵심 아이디어

> **프로그램은 CPU에서 직접 실행한다.  
단, 운영체제가 개입할 수 있는 지점을 명확히 만든다.**

이를 위해 하드웨어와 운영체제는 몇 가지 장치를 함께 사용한다.

---

### 사용자 모드와 커널 모드

CPU는 두 가지 실행 모드를 제공한다.

- **사용자 모드 (User Mode)**
    - 일반 프로세스가 실행되는 모드
    - 특권 명령어 실행 불가
- **커널 모드 (Kernel Mode)**
    - 운영체제가 실행되는 모드
    - 모든 명령어 실행 가능

프로세스는 기본적으로 사용자 모드에서 실행되며, 운영체제만이 커널 모드에서 실행된다.

이를 통해 프로그램의 실행을 **하드웨어 수준에서 제한**할 수 있다.

---

### 시스템 콜과 트랩(trap)

프로세스는 디스크 I/O, 메모리 할당, 프로세스 생성과 같은 특권 연산을 직접 수행할 수 없다.
대신 **시스템 콜(system call)** 을 통해 운영체제에게 작업을 요청한다.

시스템 콜이 호출되면 다음 과정이 발생한다.

1. trap 명령어 실행
2. CPU가 커널 모드로 전환
3. 트랩 테이블에 등록된 커널 코드 실행
4. 작업 완료 후 return-from-trap으로 사용자 모드 복귀

시스템 콜은 함수 호출처럼 보이지만, 실제로는 **하드웨어가 강제로 실행 흐름을 전환시키는 메커니즘**이다.

---

### CPU 제어권 회수 문제

프로세스가 사용자 모드에서 실행 중일 때, 운영체제는 CPU를 사용하지 않고 있다.

이때 운영체제가 CPU 제어권을 다시 얻지 못한다면 프로세스는 무한 루프에 빠져 CPU를 독점할 수 있다.

---

### 타이머 인터럽트

이 문제를 해결하기 위해 하드웨어는 **타이머 인터럽트**를 제공한다.

- 하드웨어 타이머가 일정 주기마다 인터럽트 발생
- 실행 중인 프로세스가 강제로 중단
- CPU가 커널 모드로 전환
- 운영체제가 실행 흐름을 다시 제어

이를 통해 프로세스가 비협조적으로 동작하더라도 운영체제는 항상 CPU 제어권을 유지할 수 있다.

---

### 인터럽트 발생 시 처리 흐름

1. 하드웨어가 현재 실행 중인 프로세스의 레지스터 상태 저장
2. CPU가 커널 모드로 전환
3. 인터럽트 핸들러 실행
4. 운영체제가 스케줄링 결정 수행

이 과정에서 필요하다면 **문맥 교환(Context Switch)** 이 발생한다.

---

### 문맥 교환과 비용

문맥 교환은 다음 작업을 포함한다.

- 현재 프로세스의 레지스터, 프로그램 카운터, 스택 포인터 저장
- 다음 프로세스의 상태 복원

이 과정은 단순한 함수 호출보다 훨씬 비싸며 제한적 직접 실행에서 가장 큰 비용이 발생하는 지점이다.

---

### 제한적 직접 실행의 비용 구성

제한적 직접 실행에서 비용은 다음 상황에서 발생한다.

- 시스템 콜 호출
- 타이머 인터럽트 발생
- 문맥 교환 수행

반면, 사용자 모드에서의 **직접 실행 구간은 거의 비용이 없다**.

즉, 제한적 직접 실행의 성능은 **운영체제가 얼마나 자주 개입하느냐**에 의해 결정된다.

---

### 정리

- 제한적 직접 실행은 성능과 제어를 동시에 만족시키기 위한 실행 방식이다.
- 프로그램은 사용자 모드에서 CPU에서 직접 실행된다.
- 시스템 콜과 타이머 인터럽트를 통해 운영체제는 제어권을 확보한다.
- 문맥 교환은 가장 큰 비용을 유발하는 요소이다.
- 제한적 직접 실행은 하드웨어와 운영체제가 협력하여 구현한 CPU 가상화의 핵심 메커니즘이다.
